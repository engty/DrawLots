# 桌面应用使用指南

本文档说明如何在 Windows 与 macOS 平台上构建、运行和维护桌面版抽选系统。

## 构建准备
- 安装 Rust 工具链（推荐使用 `rustup`，版本 ≥ 1.70）。
- 安装 Node.js（建议 ≥ 18）并确保已执行 `npm install` 安装 Tauri CLI 依赖。
- macOS 用户首次运行 `.app` 可能需要在「系统设置 → 隐私与安全性」中允许来自已识别开发者的应用。

## 开发模式
1. 在项目根目录执行 `npm run tauri:dev`。
2. Tauri 会直接加载根目录下的 `index.html` 与静态资源，无需额外打包步骤。
3. 调试时的历史数据会写入应用同级的 `data/draw_history.json`（如权限不足，会自动切换到系统用户目录并在界面显示提示）。

## 打包发布
- Windows：执行 `npm run tauri:build`，生成的 `DrawLots.exe` 与资源位于 `src-tauri/target/release/bundle/msi` 和 `.../bundle/app` 目录，可直接打包成压缩包连同 `data` 目录一并分发。
- macOS：同样执行 `npm run tauri:build`，生成 `DrawLots.app`；首次运行若提示权限，可右键选择「打开」。
- 建议发布时保留一个空的 `data/draw_history.json`（内容为 `[]`），保证首次启动即可写入数据。

## 数据存储策略
- 应用启动时会尝试在可执行文件同级创建 `data/` 目录，并确保存在 `draw_history.json` 与 `draw_history.bak`。
- 抽签历史的新增、编辑、删除会立即写入 JSON 文件，并同步一份缓存到 WebView 的 `localStorage`，以便浏览器模式回退。
- 若因权限导致同级目录不可写，系统会自动切换到平台默认的数据目录（如 macOS 的 `~/Library/Application Support/com.gdhp.drawlots/data`），窗口内会弹出告警提示路径。
- 每次写入前会生成 `draw_history.bak` 备份；若 JSON 文件损坏，可手动将备份重命名回主文件恢复。

## 故障排查
- 若 `data` 目录缺失或 JSON 内容为空数组，应用会自动重建；请检查磁盘权限或杀毒软件是否阻止写入。
- 遇到 “写入桌面数据失败” 提示时，可在界面再次操作或检查磁盘是否只读；必要时在 `docs/桌面应用使用指南.md` 中按照备份恢复步骤处理。
- 如需重新回到纯浏览器模式，只需在普通浏览器打开 `index.html`，历史数据将从 `localStorage` 读取。

